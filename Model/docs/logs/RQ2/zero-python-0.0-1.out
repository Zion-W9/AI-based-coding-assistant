@ Stage 3
Create Datastore
2022-08-17 19:26:21 | INFO | fairseq_cli.validate | loading model(s) from /home/cluster/jgu/scratch/ssr/cli/out/mix/zero_base_python_en_XX/checkpoint_best.pt
2022-08-17 19:26:25 | INFO | fairseq.tasks.translation | [python] dictionary: 50001 types
2022-08-17 19:26:25 | INFO | fairseq.tasks.translation | [en_XX] dictionary: 50001 types
2022-08-17 19:26:32 | INFO | fairseq_cli.validate | Namespace(activation_dropout=0.0, activation_fn='gelu', adam_betas='(0.9, 0.999)', adam_eps=1e-06, adaptive_input=False, adaptive_softmax_cutoff=None, adaptive_softmax_dropout=0, add_lang_token=True, all_gather_list_size=16384, arch='mbart_base', attention_dropout=0.1, best_checkpoint_metric='loss', bf16=False, bpe='sentencepiece', broadcast_buffers=False, bucket_cap_mb=25, checkpoint_suffix='', clip_norm=0.1, cpu=False, criterion='cross_entropy', cross_self_attention=False, curriculum=0, data='/home/cluster/jgu/scratch/ssr/cli/out/mix/python/data-bin', data_buffer_size=10, dataset_impl='mmap', ddp_backend='no_c10d', decoder_attention_heads=12, decoder_embed_dim=768, decoder_embed_path=None, decoder_ffn_embed_dim=3072, decoder_input_dim=768, decoder_layerdrop=0, decoder_layers=6, decoder_layers_to_keep=None, decoder_learned_pos=True, decoder_normalize_before=False, decoder_output_dim=768, device_id=0, disable_validation=False, distributed_backend='nccl', distributed_init_method='tcp://localhost:16473', distributed_no_spawn=False, distributed_port=-1, distributed_rank=0, distributed_world_size=8, distributed_wrapper='DDP', dropout=0.1, dstore_filename=None, dstore_fp16=True, dstore_mmap='/home/cluster/jgu/scratch/ssr/cli/out/mix/python/zero_datastore', dstore_size=601026, empty_cache_freq=0, encoder_attention_heads=12, encoder_embed_dim=768, encoder_embed_path=None, encoder_ffn_embed_dim=3072, encoder_layerdrop=0, encoder_layers=6, encoder_layers_to_keep=None, encoder_learned_pos=True, encoder_normalize_before=False, end_learning_rate=0.0, eval_bleu_detok='space', eval_bleu_remove_bpe=None, eval_tokenized_bleu=False, fast_stat_sync=False, find_unused_parameters=False, fix_batches_to_gpus=False, fixed_validation_seed=None, force_anneal=None, fp16=True, fp16_init_scale=128, fp16_no_flatten_grads=False, fp16_scale_tolerance=0.0, fp16_scale_window=None, insert=0.0, k=5, keep_best_checkpoints=-1, keep_interval_updates=10, keep_last_epochs=-1, knn_lambda=0.5, knn_sim_metric=None, knn_temperature=10, langs='java,python,en_XX', layernorm_embedding=True, left_pad_source=True, left_pad_target=False, localsgd_frequency=3, log_format='json', log_interval=10, lr=[0.0003], lr_scheduler='polynomial_decay', mask=0.3, mask_length='span-poisson', mask_random=0.1, max_epoch=0, max_sentences=32, max_sentences_valid=32, max_source_positions=1024, max_target_positions=1024, max_tokens=4096, max_tokens_valid=2048, max_update=100000, maximize_best_checkpoint_metric=False, memory_efficient_bf16=False, memory_efficient_fp16=False, min_loss_scale=0.0001, min_lr=-1, model_parallel_size=1, move_dstore_to_mem=False, multilang_sampling_alpha=0.3, no_cross_attention=False, no_epoch_checkpoints=True, no_last_checkpoints=False, no_progress_bar=False, no_save=False, no_save_optimizer_state=False, no_scale_embedding=False, no_seed_provided=False, no_token_positional_embeddings=False, no_whole_word_mask_langs='', nprocs_per_node=8, num_batch_buckets=0, num_workers=4, only_train_final_output=False, optimizer='adam', optimizer_overrides='{}', partially_finetune=False, path='/home/cluster/jgu/scratch/ssr/cli/out/mix/zero_base_python_en_XX/checkpoint_best.pt', patience=-1, permute=0.0, permute_sentences=0.0, poisson_lambda=3.5, pooler_activation_fn='tanh', pooler_dropout=0.0, power=1.0, probe=32, profile=False, quant_noise_pq=0, quant_noise_pq_block_size=8, quant_noise_scalar=0, quantization_config_path=None, relu_dropout=0.0, replace_length=1, required_batch_size_multiple=8, reset_dataloader=False, reset_lr_scheduler=False, reset_meters=False, reset_optimizer=False, restore_file='/local/wasiahmad/codebart/models/checkpoint_last.pt', rotate=0.0, sample_break_mode='complete_doc', save_dir='/local/wasiahmad/codebart/models', save_interval=1, save_interval_updates=1000, seed=1234, sentence_avg=False, sentencepiece_model='/local/wasiahmad/codebart/sentencepiece.bpe.model', share_all_embeddings=True, share_decoder_input_output_embed=True, shuffle_instance=False, skip_invalid_size_inputs_valid_test=True, slowmo_algorithm='LocalSGD', slowmo_momentum=None, source_lang='python', stop_time_hours=0, target_lang='en_XX', task='translation_from_pretrained_bart', tensorboard_logdir='/local/wasiahmad/codebart/models/tensorboard_logs', threshold_loss_scale=None, tie_adaptive_weights=False, tokenizer=None, tokens_per_sample=512, total_num_update=100000, tpu=False, train_subset='train', truncate_source=False, update_freq=[60], upsample_primary=1, use_bmuf=False, use_gpu_to_search=False, use_knn_datastore=False, use_old_adam=False, user_dir=None, valid_subset='train', validate_interval=1, warmup_updates=2000, weight_decay=0.01)
Saving fp16
2022-08-17 19:26:33 | INFO | fairseq.data.data_utils | loaded 55538 examples from: /home/cluster/jgu/scratch/ssr/cli/out/mix/python/data-bin/train.python-en_XX.python
2022-08-17 19:26:33 | INFO | fairseq.data.data_utils | loaded 55538 examples from: /home/cluster/jgu/scratch/ssr/cli/out/mix/python/data-bin/train.python-en_XX.en_XX
2022-08-17 19:26:33 | INFO | fairseq.tasks.translation | /home/cluster/jgu/scratch/ssr/cli/out/mix/python/data-bin train python-en_XX 55538 examples
/home/cluster/jgu/scratch/ssr/cli/ds_build.py:69: DeprecationWarning: `np.int` is a deprecated alias for the builtin `int`. To silence this warning, use `int` by itself. Doing this will not modify any behavior and is safe. When replacing `np.int`, you may wish to use e.g. `np.int64` or `np.int32` to specify the precision. If you wish to review your current use, check the release note link for additional information.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  dstore_vals = np.memmap(args.dstore_mmap + '/vals.npy', dtype=np.int, mode='w+',
/home/cluster/jgu/scratch/ssr/cli/ds_build.py:157: DeprecationWarning: `np.int` is a deprecated alias for the builtin `int`. To silence this warning, use `int` by itself. Doing this will not modify any behavior and is safe. When replacing `np.int`, you may wish to use e.g. `np.int64` or `np.int32` to specify the precision. If you wish to review your current use, check the release note link for additional information.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  dstore_vals[dstore_idx:reduce_size + dstore_idx] = target.unsqueeze(-1).cpu().numpy().astype(np.int)
1376
2939
3541
5902
6393
9091
10412
10999
13774
15437
18306
20298
20887
23807
26148
26605
29326
32183
33513
36086
39168
40421
42623
45760
48170
48884
51006
53977
56292
56947
58920
61581
64697
66030
67665
69959
72934
74635
76332
78602
81525
83264
83953
85604
87772
90564
92601
93233
94771
96770
99183
101997
103220
104620
106474
108760
111402
112237
113571
115292
117357
119919
121736
122862
124420
126337
128678
130435
131235
132627
134368
136462
139196
140197
141476
143030
144872
147155
148759
149875
151335
153113
155326
156975
157528
158601
159937
161511
163379
165820
167045
168226
169672
171407
173534
175239
176218
177459
178909
180591
182806
183807
184855
186173
187699
189524
191509
192202
193213
194451
195908
197652
199610
200355
201436
202771
204347
206289
207701
208248
209147
210260
211577
213145
215136
216095
217002
218118
219423
220972
222910
223772
224536
225516
226662
227992
229536
231589
232589
233484
234558
235796
237239
238960
240794
241481
242420
243551
244866
246445
248085
248759
249571
250572
251719
253071
254768
256034
256784
257702
258791
260044
261535
263236
264030
264855
265839
266974
268294
269980
271789
272411
273228
274183
275285
276576
278196
279352
280018
280849
281800
282898
284200
285952
286652
287429
288333
289358
290525
291868
293710
294528
295266
296169
297188
298359
299738
301385
301922
302619
303457
304437
305551
306836
308253
308803
309473
310283
311221
312296
313598
315358
315911
316631
317485
318480
319630
321048
322466
323069
323842
324747
325796
327004
328595
329452
330161
331000
331983
333128
334529
335696
336253
336929
337707
338602
339657
340965
342366
342920
343596
344375
345269
346300
347579
348677
349236
349956
350804
351808
353041
354305
354812
355478
356260
357171
358235
359806
360451
361103
361882
362802
363887
365319
366272
366768
367365
368046
368842
369753
370832
371942
372445
373058
373753
374557
375512
376759
377730
378248
378863
379578
380377
381334
382683
383196
383784
384460
385249
386153
387309
388237
388780
389443
390191
391076
392112
393456
393940
394558
395282
396123
397157
398551
399020
399623
400343
401167
402161
403639
404168
404770
405495
406365
407462
408463
408899
409441
410051
410733
411524
412484
413828
414231
414740
415318
415989
416792
417812
418661
419135
419711
420373
421120
421975
423079
423970
424450
425037
425747
426584
427586
428611
429060
429617
430256
430977
431810
432898
433565
434043
434609
435247
435979
436849
438125
438519
439014
439598
440271
441043
441947
443147
443578
444119
444757
445493
446386
447705
448100
448608
449189
449853
450640
451592
452719
453079
453517
454018
454568
455199
455910
456776
457452
457850
458329
458884
459520
460262
461276
461950
462347
462836
463391
464035
464802
465911
466240
466672
467205
467821
468549
469463
470080
470464
470925
471464
472076
472803
473736
474262
474671
475153
475718
476370
477133
478262
478698
479136
479653
480268
481012
482077
482551
483004
483536
484143
484851
485838
486439
486844
487321
487876
488523
489291
490336
490671
491121
491655
492291
493031
494143
494483
494934
495476
496106
496864
497953
498309
498780
499342
500004
500828
501628
501936
502313
502745
503240
503808
504473
505287
505578
505941
506355
506831
507381
508028
508954
509339
509684
510092
510570
511125
511823
512696
513002
513385
513844
514384
515005
515790
516522
516834
517226
517688
518230
518885
519629
519917
520286
520734
521253
521863
522725
523065
523443
523891
524410
525055
525928
526202
526547
526961
527457
528018
528705
529321
529648
530053
530528
531094
531899
532395
532742
533149
533617
534162
534806
535560
535878
536278
536742
537267
537937
538902
539193
539586
540045
540575
541243
541886
542226
542637
543121
543664
544322
544898
545228
545637
546114
546682
547376
548072
548407
548834
549350
549962
550728
551311
551660
552084
552599
553233
554207
554561
554930
555390
555949
556665
557146
557435
557766
558142
558583
559115
559790
560039
560371
560752
561195
561706
562354
562864
563138
563480
563877
564331
564884
565330
565594
565912
566289
566745
567284
567970
568207
568508
568848
569234
569678
570213
570971
571185
571460
571809
572210
572689
573376
573770
574054
574404
574816
575311
576001
576338
576614
576946
577341
577823
578467
578973
579235
579558
579943
580384
580948
581728
581950
582241
582606
583025
583523
584231
584460
584792
585181
585626
586198
586803
587058
587381
587758
588206
588797
589318
589598
589960
590386
590916
591706
591955
592271
592648
593085
593616
594144
594425
594781
595203
595739
596457
596682
596977
597336
597762
598312
598828
599092
599408
599776
600197
600707
601026
much more than dstore size break
Build Faiss Index
/home/cluster/jgu/scratch/ssr/cli/ds_train.py:28: DeprecationWarning: `np.int` is a deprecated alias for the builtin `int`. To silence this warning, use `int` by itself. Doing this will not modify any behavior and is safe. When replacing `np.int`, you may wish to use e.g. `np.int64` or `np.int32` to specify the precision. If you wish to review your current use, check the release note link for additional information.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  vals = np.memmap(args.dstore_mmap + '/vals.npy', dtype=np.int, mode='r', shape=(args.dstore_size, 1))
Namespace(code_size=64, dimension=768, dstore_fp16=True, dstore_mmap='/home/cluster/jgu/scratch/ssr/cli/out/mix/python/zero_datastore', dstore_size=601026, faiss_index='/home/cluster/jgu/scratch/ssr/cli/out/mix/python/zero_datastore/knn_index', ncentroids=4096, probe=32, seed=1, starting_point=0)
done.
Start put index to gpu
Training Index
[372585  13403 243731 423153 392567 512461 516163 453239  41018 558783]
[[ 2.178    0.2678  -0.2817  ... -0.03784 -1.475   -1.721  ]
 [-1.727   -1.853   -2.59    ...  0.669   -0.1664   1.195  ]
 [ 2.102   -0.3516  -3.01    ... -2.842    0.7573  -0.2423 ]
 ...
 [ 1.439   -0.3254  -1.17    ... -0.4106   0.769    0.3347 ]
 [ 1.771   -1.028   -0.6787  ...  1.325    2.516   -1.373  ]
 [ 0.5     -0.957   -1.117   ...  1.687   -0.8403   0.542  ]]
Training took 18.20112156867981 s
Writing index after training
Writing index took 0.0198209285736084 s
Adding Keys
Added 1000000 tokens so far
Writing Index 1000000
Adding total 601026 keys
Adding took 3.890606164932251 s
Writing Index
Writing index took 0.14049816131591797 s
@ Completed
@ Stage 4
/net/cephfs/scratch/jgu/ssr/fairseq/search.py:140: UserWarning: __floordiv__ is deprecated, and its behavior will change in a future version of pytorch. It currently rounds toward 0 (like the 'trunc' function NOT 'floor'). This results in incorrect rounding for negative values. To keep the current behavior, use torch.div(a, b, rounding_mode='trunc'), or for actual floor division, use torch.div(a, b, rounding_mode='floor').
  beams_buf = indices_buf // vocab_size
/net/cephfs/scratch/jgu/ssr/fairseq/sequence_generator.py:651: UserWarning: __floordiv__ is deprecated, and its behavior will change in a future version of pytorch. It currently rounds toward 0 (like the 'trunc' function NOT 'floor'). This results in incorrect rounding for negative values. To keep the current behavior, use torch.div(a, b, rounding_mode='trunc'), or for actual floor division, use torch.div(a, b, rounding_mode='floor').
  unfin_idx = idx // beam_size
WARNING (theano.tensor.blas): We did not find a dynamic library in the library_dir of the library we use for blas. If you use ATLAS, make sure to compile it with dynamics library.
c_bleu = 0.26 | s_bleu = 4.45 | meteor = 6.83 | rouge = 9.95
@ Completed
